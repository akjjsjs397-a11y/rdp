name: Colab-Style Linux RDP

on:
  workflow_dispatch:

jobs:
  rdp-colab-style:
    # üéØ Force Ubuntu 22.04 (Matches standard Google Colab)
    runs-on: ubuntu-22.04
    timeout-minutes: 3600  # 60 hours max

    steps:
      - name: Install Desktop & XRDP
        run: |
          sudo apt-get update
          
          # Install XFCE4, XRDP, and D-Bus utilities
          # dbus-x11 is CRITICAL for the fix
          sudo apt-get install -y xfce4 xfce4-goodies xrdp dbus-x11
          
          # ---------------------------------------------------
          # üîß FIX FOR FAILSAFE SESSION ERROR
          # ---------------------------------------------------
          # Use dbus-launch to start a proper session bus for XFCE
          echo "dbus-launch --exit-with-session xfce4-session" > ~/.xsession
          
          # Make .xsession executable
          chmod +x ~/.xsession
          
          # Restart XRDP service to apply changes
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          
          # Open firewall port 3389 (standard RDP port)
          sudo ufw allow 3389/tcp || true
          
          echo "‚úÖ Desktop Environment Ready (with D-Bus fix)"

      - name: Create 'colab' User
        run: |
          # Create a familiar user 'colab'
          sudo useradd -m -s /bin/bash colab
          
          # Set password to '1234'
          echo "colab:1234" | sudo chpasswd
          
          # Grant sudo access (root rights)
          sudo usermod -aG sudo colab
          
          echo "‚úÖ User 'colab' created with password '1234'"

      - name: Install Tailscale
        run: |
          # Add Tailscale repo for Ubuntu 22.04 (Jammy)
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          sudo apt-get update
          sudo apt-get install -y tailscale
          
          echo "‚úÖ Tailscale Installed"

      - name: Connect to Tailscale
        run: |
          # Connect to your Tailscale network
          # Ensure 'TAILSCALE_AUTHKEY' is added in GitHub Secrets
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname="colab-replica-${{ github.run_number }}" --ssh
          
          TAILSCALE_IP=$(tailscale ip -4)
          
          echo "========================================="
          echo "üéØ RDP CREDENTIALS"
          echo "========================================="
          echo "IP Address:  $TAILSCALE_IP"
          echo "Username:    colab"
          echo "Password:    1234"
          echo "System:      Ubuntu 22.04 LTS"
          echo "========================================="

      - name: Keep Alive
        run: |
          echo "‚è≥ RDP Server Running..."
          echo "üí° Connect using Remote Desktop (mstsc.exe) or Remmina"
          
          # Prevent sleep/suspend
          sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
          
          # Infinite loop to keep runner active
          while true; do
            sleep 300
            echo "$(date) - Still alive..."
          done
