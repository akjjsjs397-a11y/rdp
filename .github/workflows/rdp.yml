name: Colab-Style Linux RDP

on:
  workflow_dispatch:

jobs:
  rdp-colab-style:
    # üéØ FORCE UBUNTU 22.04 (Same as standard Colab notebooks)
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Install Desktop & XRDP
        run: |
          sudo apt-get update
          
          # Install XFCE4 (Lightweight Desktop) & XRDP
          # This mimics having a display, which Colab usually doesn't have by default
          # but is required for RDP to work.
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          
          # Configure XRDP to use XFCE
          echo "xfce4-session" > ~/.xsession
          
          # Enable and start XRDP service
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          
          # Open firewall port 3389
          sudo ufw allow 3389/tcp || true
          
          echo "‚úÖ Desktop Environment Ready"

      - name: Create 'colab' User
        run: |
          # Create a user named 'colab' to feel familiar
          sudo useradd -m -s /bin/bash colab
          
          # Set password to '1234'
          echo "colab:1234" | sudo chpasswd
          
          # Give sudo rights (root access)
          sudo usermod -aG sudo colab
          
          echo "‚úÖ User 'colab' created"

      - name: Install Tailscale
        run: |
          # Install Tailscale for Ubuntu 22.04 (Jammy)
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          sudo apt-get update
          sudo apt-get install -y tailscale
          
          echo "‚úÖ Tailscale Installed"

      - name: Connect to Tailscale
        run: |
          # Connect using the secret you added
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname="colab-replica-${{ github.run_number }}" --ssh
          
          TAILSCALE_IP=$(tailscale ip -4)
          
          echo "========================================="
          echo "üéØ RDP CREDENTIALS"
          echo "========================================="
          echo "IP:       $TAILSCALE_IP"
          echo "User:     colab"
          echo "Pass:     1234"
          echo "OS:       Ubuntu 22.04 LTS (Colab Match)"
          echo "========================================="

      - name: Keep Alive
        run: |
          echo "‚è≥ Running... Connect now via RDP!"
          sudo systemctl mask sleep.target suspend.target
          while true; do sleep 300; echo "Still alive..."; done
