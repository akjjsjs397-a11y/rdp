name: Linux RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  rdp-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 3600  # 60 hours

    steps:
      - name: Install Desktop Environment & XRDP
        run: |
          sudo apt-get update
          
          # Install XFCE4 (Lightweight Desktop) & XRDP
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          
          # Configure XRDP to use XFCE
          echo "xfce4-session" > ~/.xsession
          
          # Enable and start XRDP service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Open RDP port in firewall (if ufw is active, usually open on runners)
          sudo ufw allow 3389/tcp || true
          
          echo "‚úÖ Desktop & XRDP Installed"

      - name: Create RDP User
        run: |
          # Create user 'linuxuser' with password '1234'
          # GitHub runners already have a 'runner' user, but we'll make a dedicated one
          sudo useradd -m -s /bin/bash linuxuser
          echo "linuxuser:1234" | sudo chpasswd
          
          # Grant sudo access (optional)
          sudo usermod -aG sudo linuxuser
          
          echo "‚úÖ User Created: linuxuser"
          echo "‚úÖ Password: 1234"

      - name: Install Tailscale
        run: |
          # Add Tailscale's package signature and repository
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          sudo apt-get update
          sudo apt-get install -y tailscale
          
          echo "‚úÖ Tailscale Installed"

      - name: Connect to Tailscale
        run: |
          # Start Tailscale
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname="github-linux-${{ github.run_number }}" --ssh
          
          echo "‚úÖ Tailscale Connected"
          
          # Get Tailscale IP
          TAILSCALE_IP=$(tailscale ip -4)
          
          echo "========================================="
          echo "üéØ RDP CONNECTION INFO"
          echo "========================================="
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username: linuxuser"
          echo "Password: 1234"
          echo "========================================="
          echo "üíª Connect using: mstsc.exe or Remmina"
          echo "========================================="

      - name: Keep Alive
        run: |
          echo "‚è≥ Linux RDP Server Running..."
          echo "üí° This will run for 60 hours or until you stop it"
          
          # Disable default sleep/suspend to be safe
          sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
          
          # Infinite loop
          while true; do
            sleep 300
            echo "$(date) - Still running..."
          done
